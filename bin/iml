#!/usr/bin/env ruby
# frozen_string_literal: true

require 'iml'
require 'optparse'

options = {}
logger = Logger.new(STDOUT)

begin
  OptionParser.new do |opts|
    opts.banner = "Usage: #{File.basename $PROGRAM_NAME} [options] MEDIA_FILE [MEDIA_FILE] ..."

    opts.on('-v', '--[no-]verbose', 'Run verbosely') do |v|
      options[:verbose] = v
    end
    opts.on('-p', '--[no-]pretend', 'Dry run, do not move any files') do |p|
      options[:pretend] = p
    end
    opts.on('-t', '--target PATH', 'Path to move media files to, default: current directory') do |t|
      options[:target] = t
    end
    opts.on('-f', '--movie-format FORMAT', "Format of the output path of movies, default: '#{IML::Movie::DEFAULT_FORMAT}'") do |f|
      options[:movie_format] = f
    end
    opts.on('-g', '--tv-format FORMAT', "Format of the output path of movies, default: '#{IML::TVSeries::DEFAULT_FORMAT}'") do |f|
      options[:tv_format] = f
    end
    opts.on('-F', '--format', 'Format description') do |f|
      options[:format] = f
    end
    puts opts if opts.default_argv.empty? && STDIN.tty?
  end.parse!
rescue OptionParser::InvalidOption => e
  logger.error e.message
end

if options[:format]
  puts <<~FORMAT
    Formatting description:
    %T - title
    %t - episode title
    %Y - year
    %S - season number string as found in the input path
    %s - season number integer
    %E - episode number string as found in the input path
    %e - episode number integer
    %g - group name
    %a - audio codec
    %v - video codec
    %f - file format / extension
    %z - source
    %q - quality

  FORMAT
  exit
end

input = STDIN.tty? ? ARGV : $stdin.readlines

input ||= ARGV

input.map { |p| Pathname(p.chomp) }.each do |path|
  filename = path.basename.to_s
  unless path.exist?
    logger.warn("File #{path} does not exist, skipping")
    next
  end
  media = IML::Text.new(filename).detect
  unless media
    logger.warn "#{path} doesn't look like a media file" if options[:verbose] || options[:pretend]
    next
  end
  if media.movie?
    media.format_string = options[:movie_format] if options[:movie_format]
    logger.info "#{path} looks like a movie"
  elsif media.tv?
    media.format_string = options[:tv_format] if options[:tv_format]
    logger.info "#{path} looks like a TV series"
  end
  dirname = options[:target] ? Pathname(options[:target]) + media.dirname : media.dirname
  pathname = options[:target] ? Pathname(options[:target]) + media.pathname : media.pathname
  unless dirname.to_s == '.'
    logger.info "Creating #{dirname}" if options[:verbose] || options[:pretend]
    FileUtils.mkdir_p dirname unless options[:pretend]
  end
  logger.info "Moving #{path} to #{pathname}" if options[:verbose] || options[:pretend]
  FileUtils.mv path, pathname unless options[:pretend]
end
